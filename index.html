<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë‚­ë§Œ MMORPG: ëª¨í—˜ì˜ ì„œ</title>
    <link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@400;700&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- ğŸ¨ ë‚­ë§Œ RPG ê°ì„± ë””ìì¸ --- */
        :root {
            --gold: #f3cf7a;
            --dark-brown: #3e2723;
            --wood: #5d4037;
            --soft-glow: 0 0 15px rgba(243, 207, 122, 0.5);
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            font-family: 'Gaegu', cursive; /* ê·€ì—¬ìš´ í°íŠ¸ ì ìš© */
            background: url('https://images.unsplash.com/photo-1518709268805-4e9042af9f23?auto=format&fit=crop&w=1920&q=80') no-repeat center center fixed;
            background-size: cover;
            color: #eee;
            overflow: hidden;
        }

        /* í™”ë©´ ì „í™˜ íš¨ê³¼ */
        .screen {
            display: none; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            position: absolute; justify-content: center; align-items: center;
            animation: fadeIn 0.8s ease-in-out;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .active { display: flex; }

        /* --- ğŸ” ë¡œê·¸ì¸ & ê°€ì… (ì •í†µ RPG ìŠ¤íƒ€ì¼) --- */
        .auth-box {
            background: linear-gradient(145deg, #4e342e, #2b1d1a);
            padding: 40px;
            border: 4px solid var(--gold);
            border-radius: 20px;
            text-align: center;
            width: 380px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8), var(--soft-glow);
        }

        .auth-box h2 { font-size: 32px; color: var(--gold); margin-bottom: 20px; text-shadow: 2px 2px #000; }

        .input-group { position: relative; margin-bottom: 20px; }
        .input-group input {
            width: 100%; padding: 12px; box-sizing: border-box;
            background: #1a1210; border: 2px solid #8d6e63;
            color: var(--gold); border-radius: 10px; font-size: 18px;
        }
        .eye-icon { position: absolute; right: 15px; top: 12px; cursor: pointer; font-size: 20px; }

        .btn-game {
            background: linear-gradient(to bottom, #8d6e63, #3e2723);
            border: 2px solid var(--gold);
            color: var(--gold);
            padding: 12px 30px;
            font-size: 20px;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-shadow: 1px 1px 2px #000;
            width: 100%;
        }
        .btn-game:hover { transform: scale(1.03); filter: brightness(1.2); box-shadow: var(--soft-glow); }

        /* --- ğŸ‘¤ ì„±ë³„ ì„ íƒ (ê·¸ë¦¼ì ì‹¤ë£¨ì—£) --- */
        .gender-container { display: flex; gap: 40px; }
        .gender-card {
            cursor: pointer; transition: 0.3s; filter: grayscale(100%); opacity: 0.6;
        }
        .gender-card:hover { filter: grayscale(0%); opacity: 1; transform: translateY(-10px); }
        .gender-silhouette {
            width: 160px; height: 260px;
            background-size: contain; background-repeat: no-repeat; background-position: center;
        }
        /* ë‚¨ì„±/ì—¬ì„± ì‹¤ë£¨ì—£ ì´ë¯¸ì§€ (SVG ì•„ì´ì½˜ í™œìš©) */
        .male-img { background-image: url('https://www.svgrepo.com/show/347201/male-silhouette.svg'); filter: invert(0.8); }
        .female-img { background-image: url('https://www.svgrepo.com/show/347200/female-silhouette.svg'); filter: invert(0.8); }

        /* --- âš”ï¸ ë©”ì¸ UI --- */
        .main-container {
            display: grid; grid-template-columns: 280px 1fr 320px;
            width: 95%; height: 90%; gap: 20px;
        }
        .panel {
            background: rgba(43, 29, 26, 0.9);
            border: 3px solid var(--gold);
            border-radius: 15px;
            padding: 20px;
            overflow-y: auto;
            box-shadow: inset 0 0 10px #000;
        }

        .user-mini-card {
            display: flex; align-items: center; margin-bottom: 15px;
            padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.3);
            border: 1px solid #5d4037; cursor: pointer;
        }
        .mini-img { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--gold); margin-right: 12px; }

        .char-preview {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .char-frame {
            width: 350px; height: 500px; border: 8px double var(--gold);
            background: radial-gradient(circle, #5d4037, #1a1210);
            border-radius: 50px 50px 10px 10px; position: relative;
            overflow: hidden; animation: float 5s infinite ease-in-out;
        }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }

        .admin-note {
            background: #fff9c4; color: #333; padding: 10px; margin-top: 10px;
            border-radius: 5px; font-size: 14px; border-left: 5px solid #fbc02d;
        }
        
        .tag {
            display: inline-block; padding: 5px 12px; margin: 4px;
            background: #3e2723; border: 1px solid var(--gold);
            border-radius: 20px; font-size: 14px; cursor: pointer;
        }
        .tag.active { background: var(--gold); color: #3e2723; font-weight: bold; }

    </style>
</head>
<body>

    <div id="login-screen" class="screen active">
        <div class="auth-box">
            <h2>LOG IN</h2>
            <div class="input-group"><input type="email" id="login-email" placeholder="ì´ë©”ì¼ ì•„ì´ë””"></div>
            <div class="input-group">
                <input type="password" id="login-pw" placeholder="ë¹„ë°€ë²ˆí˜¸">
                <span class="eye-icon" onclick="togglePw('login-pw')">ğŸ‘ï¸</span>
            </div>
            <button class="btn-game" onclick="handleLogin()">ì„¸ê³„ë¡œ ì…ì¥</button>
            <p style="margin-top:20px; cursor:pointer; color: #aaa;" onclick="showScreen('signup-screen')">ìƒˆë¡œìš´ ëª¨í—˜ê°€ì´ì‹ ê°€ìš”?</p>
        </div>
    </div>

    <div id="signup-screen" class="screen">
        <div class="auth-box" style="border-color: #f8bbd0;">
            <h2 style="color:#f8bbd0;">SIGN UP</h2>
            <div class="input-group"><input type="email" id="signup-email" placeholder="ì‚¬ìš©í•  ì´ë©”ì¼"></div>
            <div class="input-group">
                <input type="password" id="signup-pw" placeholder="ë¹„ë°€ë²ˆí˜¸">
                <span class="eye-icon" onclick="togglePw('signup-pw')">ğŸ‘ï¸</span>
            </div>
            <button class="btn-game" style="background: #6a1b9a;" onclick="handleSignup()">ê³„ì • ìƒì„±</button>
            <button class="btn-game" style="margin-top:10px; border:none; background:none; color:#aaa;" onclick="showScreen('login-screen')">ì´ì „ìœ¼ë¡œ</button>
        </div>
    </div>

    <div id="gender-screen" class="screen">
        <div style="text-align: center;">
            <h1 style="color: var(--gold); text-shadow: 2px 2px 5px #000; font-size: 40px;">ëª¨í—˜ê°€ì˜ ì„±ë³„ì„ ì„ íƒí•˜ì„¸ìš”</h1>
            <div class="gender-container">
                <div class="gender-card" onclick="selectGender('ë‚¨ì„±')">
                    <div class="gender-silhouette male-img"></div>
                    <h2 style="color: #90caf9;">MALE</h2>
                </div>
                <div class="gender-card" onclick="selectGender('ì—¬ì„±')">
                    <div class="gender-silhouette female-img"></div>
                    <h2 style="color: #f48fb1;">FEMALE</h2>
                </div>
            </div>
        </div>
    </div>

    <div id="main-screen" class="screen">
        <div class="main-container">
            <div class="panel">
                <h3 style="border-bottom: 2px solid var(--gold); padding-bottom: 10px;">ìµœê·¼ ëª¨í—˜ê°€</h3>
                <div id="recent-users-list"></div>
            </div>

            <div class="char-preview">
                <div class="char-frame">
                    <img id="char-img-display" src="" style="width:100%; height:100%; object-fit: cover; display:none;">
                    <div id="upload-placeholder" style="text-align:center; padding-top: 180px;">
                        <button class="btn-game" style="width:auto;" onclick="document.getElementById('file-input').click()">â• ì‚¬ì§„ ë“±ë¡</button>
                        <p style="color: var(--gold); margin-top:10px;">ìºë¦­í„°ì˜ ëª¨ìŠµì„ ì˜¬ë ¤ì£¼ì„¸ìš”</p>
                    </div>
                    <input type="file" id="file-input" hidden accept="image/*" onchange="previewImage(event)">
                </div>
            </div>

            <div class="panel">
                <div style="display:flex; align-items:center; justify-content:space-between;">
                    <span style="font-size:20px; color:var(--gold);">LEVEL</span>
                    <div>
                        <button class="btn-game" style="width:30px; padding:5px;" onclick="changeLv(-1)">-</button>
                        <span id="lv-val" style="font-size: 24px; margin: 0 10px;">1</span>
                        <button class="btn-game" style="width:30px; padding:5px;" onclick="changeLv(1)">+</button>
                    </div>
                </div>
                <hr style="border:1px solid #5d4037; margin:15px 0;">

                <label>ë‹‰ë„¤ì„</label>
                <input type="text" id="nickname" placeholder="ëª¨í—˜ê°€ì˜ ì´ë¦„" style="width:100%; padding:10px; margin:8px 0; background:#1a1210; border:1px solid var(--gold); color:white; border-radius:5px;">

                <label>ì¢…ì¡±</label>
                <select id="race" style="width:100%; padding:10px; margin:8px 0; background:#1a1210; border:1px solid var(--gold); color:white; border-radius:5px;">
                    <option>ì¸ê°„</option><option>ì—˜í”„</option><option>ë“œì›Œí”„</option>
                </select>

                <label>íŠ¹ì„±</label>
                <div class="trait-tags" id="trait-container">
                    <span class="tag" onclick="toggleTag(this)">ê¹Œì¹ í•¨</span>
                    <span class="tag" onclick="toggleTag(this)">ë‹¤ì •í•¨</span>
                    <span class="tag" onclick="toggleTag(this)">ì¬ëŠ¥ìˆìŒ</span>
                    <span class="tag" onclick="addCustomTag()">+ ê¸°íƒ€</span>
                </div>

                <label>í•œì¤„ ì†Œê°œ</label>
                <textarea id="bio" rows="3" style="width:100%; background:#1a1210; color:white; border:1px solid var(--gold); border-radius:5px; margin-top:8px;"></textarea>

                <button class="btn-game" style="margin-top:20px;" onclick="saveCharacter()">ì •ë³´ ì €ì¥í•˜ê¸°</button>
                <button class="btn-game" style="margin-top:10px; background: #c62828; font-size:14px; padding:5px;" onclick="handleLogout()">ì ‘ì† ì¢…ë£Œ</button>
                
                <div id="admin-section" style="display:none; margin-top:20px;">
                    <hr>
                    <p style="color:var(--gold)">ğŸš© ê´€ë¦¬ì ì „ìš© ìª½ì§€</p>
                    <textarea id="admin-msg" placeholder="í•´ë‹¹ ìœ ì €ì—ê²Œ ìª½ì§€ ë‚¨ê¸°ê¸°..." style="width:100%; background:#000; color:white;"></textarea>
                    <button class="btn-game" onclick="sendAdminNote()">ìª½ì§€ ë‚¨ê¸°ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, limit, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB9zSYPDBJRt2oTIcbEa8kxZplCvSPazUU",
            authDomain: "prof-f0cd2.firebaseapp.com",
            projectId: "prof-f0cd2",
            storageBucket: "prof-f0cd2.firebasestorage.app",
            messagingSenderId: "966274708581",
            appId: "1:966274708581:web:1f77eae3bb147c0bce028c"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let userRole = 'user';

        // í™”ë©´ ì „í™˜ í•¨ìˆ˜
        window.showScreen = (id) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        };

        // ë¹„ë°€ë²ˆí˜¸ ëˆˆ ì•„ì´ì½˜
        window.togglePw = (id) => {
            const input = document.getElementById(id);
            input.type = input.type === 'password' ? 'text' : 'password';
        };

        // ì„±ë³„ ì„ íƒ í›„ ë©”ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™ (ê°€ì¥ ì¤‘ìš”í•œ ë¶€ë¶„!)
        window.selectGender = async (gender) => {
            const user = auth.currentUser;
            if (user) {
                // DBì— ì„±ë³„ ì €ì¥
                await setDoc(doc(db, "users", user.uid), { gender: gender }, { merge: true });
                showScreen('main-screen');
                loadRecentUsers();
            }
        };

        // íšŒì›ê°€ì…
        window.handleSignup = async () => {
            const email = document.getElementById('signup-email').value;
            const pw = document.getElementById('signup-pw').value;
            try {
                await createUserWithEmailAndPassword(auth, email, pw);
                alert("ë°˜ê°‘ìŠµë‹ˆë‹¤! ëª¨í—˜ê°€ë‹˜.");
                showScreen('gender-screen');
            } catch(e) { alert(e.message); }
        };

        // ë¡œê·¸ì¸
        window.handleLogin = async () => {
            const email = document.getElementById('login-email').value;
            const pw = document.getElementById('login-pw').value;
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, pw);
                const userDoc = await getDoc(doc(db, "users", userCredential.user.uid));
                
                if (userDoc.exists() && userDoc.data().status === 'deleted') {
                    alert("íƒˆí‡´í•œ íšŒì›ì…ë‹ˆë‹¤.");
                    await signOut(auth);
                    return;
                }

                // ì„±ë³„ ì„ íƒ ì—¬ë¶€ì— ë”°ë¼ í™”ë©´ ê²°ì •
                if (userDoc.exists() && userDoc.data().gender) {
                    showScreen('main-screen');
                    loadRecentUsers();
                } else {
                    showScreen('gender-screen');
                }

                // ì–´ë“œë¯¼ ì²´í¬
                if (userDoc.exists() && userDoc.data().role === 'admin') {
                    userRole = 'admin';
                    document.getElementById('admin-section').style.display = 'block';
                }
            } catch(e) { alert("ë¡œê·¸ì¸ ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."); }
        };

        // ë¡œê·¸ì•„ì›ƒ
        window.handleLogout = () => { signOut(auth); location.reload(); };

        // ë ˆë²¨ ì¡°ì ˆ
        let currentLv = 1;
        window.changeLv = (amt) => {
            currentLv = Math.max(1, Math.min(500, currentLv + amt));
            document.getElementById('lv-val').innerText = currentLv;
        };

        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
        let selectedFile;
        window.previewImage = (e) => {
            selectedFile = e.target.files[0];
            const reader = new FileReader();
            reader.onload = () => {
                const img = document.getElementById('char-img-display');
                img.src = reader.result;
                img.style.display = 'block';
                document.getElementById('upload-placeholder').style.display = 'none';
            };
            reader.readAsDataURL(selectedFile);
        };

        // ë°ì´í„° ì €ì¥
        window.saveCharacter = async () => {
            const user = auth.currentUser;
            if(!user) return;

            let imageUrl = document.getElementById('char-img-display').src;
            if(selectedFile) {
                const sRef = ref(storage, `chars/${user.uid}`);
                await uploadBytes(sRef, selectedFile);
                imageUrl = await getDownloadURL(sRef);
            }

            const traits = Array.from(document.querySelectorAll('.tag.active')).map(t => t.innerText);

            await updateDoc(doc(db, "users", user.uid), {
                nickname: document.getElementById('nickname').value,
                level: currentLv,
                race: document.getElementById('race').value,
                traits: traits,
                bio: document.getElementById('bio').value,
                imageUrl: imageUrl,
                updatedAt: new Date()
            });

            alert("ìºë¦­í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
        };

        // ìµœê·¼ ìœ ì € ëª©ë¡ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
        function loadRecentUsers() {
            const q = query(collection(db, "users"), orderBy("updatedAt", "desc"), limit(5));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('recent-users-list');
                list.innerHTML = "";
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (!data.nickname) return; // ë‹‰ë„¤ì„ ì—†ëŠ” ì´ˆê¸° ìœ ì €ëŠ” íŒ¨ìŠ¤
                    const card = document.createElement('div');
                    card.className = "user-mini-card";
                    card.innerHTML = `
                        <img class="mini-img" src="${data.imageUrl || 'https://via.placeholder.com/50'}">
                        <div>
                            <div style="font-weight:bold; color:var(--gold);">${data.nickname}</div>
                            <div style="font-size:12px;">Lv.${data.level} ${data.gender || ''} ${data.race}</div>
                        </div>
                    `;
                    card.onclick = () => alert(`[${data.nickname}] ë‹˜ì˜ ì†Œê°œ: ${data.bio}`);
                    list.appendChild(card);
                });
                // ë¹ˆì¹¸ ì±„ìš°ê¸°
                for(let i=snapshot.size; i<5; i++) {
                    list.innerHTML += `<div class="user-mini-card" style="opacity:0.3;"><div class="mini-img"></div>ë¹„ì–´ìˆìŒ</div>`;
                }
            });
        }
    </script>
</body>
</html>