<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚­ë§Œ MMORPG: ëª¨í—˜ì˜ ì„œ</title>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@700;800&family=Gaegu:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --forest-green: #2d4c3b;
            --magic-gold: #e2b04a;
            --paper-dark: #3e2723;
            --paper-light: #f4e4bc;
            --fairy-dust: rgba(255, 255, 200, 0.6);
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            font-family: 'Gaegu', cursive;
            /* ë°°ê²½: ë²„ë ¤ì§„ ë™í™” ì„±ê³¼ ìš”ì •ì˜ ìˆ² ëŠë‚Œ (AI ìƒì„± ì´ë¯¸ì§€ í’) */
            background: #1a1a1a url('https://images.unsplash.com/photo-1518709268805-4e9042af9f23?q=80&w=1920&auto=format&fit=crop') no-repeat center center fixed;
            background-size: cover;
            overflow: hidden; color: var(--paper-dark);
        }

        /* ì „ì²´ í™”ë©´ í•„í„°: ì•„ë‚ ë¡œê·¸ ê°ì„± */
        .sepia-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 20%, rgba(0,0,0,0.4) 100%);
            pointer-events: none; z-index: 5;
        }

        /* ìº”ë²„ìŠ¤ íš¨ê³¼: ë°˜ì§ì´ëŠ” ìš”ì • ê°€ë£¨ */
        #fairy-canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 6; }

        .screen { display: none; width: 100%; height: 100%; position: absolute; justify-content: center; align-items: center; z-index: 10; }
        .active { display: flex; animation: fadeIn 1s ease; }

        /* ë‚˜ë¬´ ì¤„ê¸° í”„ë ˆì„ & ì–‘í”¼ì§€ íŒë„¬ */
        .book-panel {
            background: var(--paper-light) url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            border: 15px solid;
            border-image: url('https://i.pinimg.com/originals/30/9b/30/309b3010f36746f363c3336d39634e9e.png') 30 fill stretch; /* ë‚˜ë¬´ ì¤„ê¸° ëŠë‚Œ ëŒ€ìš© */
            box-shadow: 0 0 50px rgba(0,0,0,0.7), inset 0 0 20px rgba(0,0,0,0.2);
            position: relative; border-radius: 5px;
        }

        /* ë©”ì¸ ë ˆì´ì•„ì›ƒ (3ë‹¨ êµ¬ì„±) */
        .main-container {
            display: grid; grid-template-columns: 320px 1fr 420px;
            width: 96vw; height: 92vh; gap: 15px; padding: 10px;
        }

        /* ì•„ì¹´ì´ë¸Œ ë¦¬ìŠ¤íŠ¸: ë‚¡ì€ ì¼ì§€ ëŠë‚Œ */
        .scroll-list { 
            overflow-y: auto; padding: 15px; height: 80%;
            mask-image: linear-gradient(to bottom, black 90%, transparent);
        }
        .archive-card {
            background: rgba(139, 90, 43, 0.1); margin-bottom: 12px;
            padding: 12px; border: 1px solid rgba(139, 90, 43, 0.3);
            border-radius: 5px; cursor: pointer; display: flex; align-items: center; gap: 12px;
            transition: 0.3s;
        }
        .archive-card:hover { transform: scale(1.02); background: rgba(139, 90, 43, 0.2); }
        .mini-pfp { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--magic-gold); object-fit: cover; }

        /* ìºë¦­í„° í¬í„¸: ì¤‘ì•™ ì „ì‹œ */
        .hero-portal {
            position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
        }
        .hero-main-img { 
            max-width: 90%; max-height: 80%; filter: drop-shadow(0 0 20px white);
            transition: 0.5s; object-fit: contain;
        }

        /* ì…ë ¥ì°½ ìŠ¤íƒ€ì¼: ì‰í¬ë³‘ ê°ì„± */
        .stat-group { margin-bottom: 15px; }
        .stat-group label { display: block; font-weight: bold; color: #5d4037; margin-bottom: 5px; }
        input, select, textarea {
            width: 100%; background: rgba(0,0,0,0.05); border: none;
            border-bottom: 2px solid #8b5a2b; padding: 8px;
            font-family: 'Gaegu'; font-size: 1.1rem; box-sizing: border-box;
        }
        input:focus { outline: none; border-bottom-color: var(--magic-gold); background: rgba(255,255,255,0.3); }

        /* ë²„íŠ¼: ë§ˆë²• ë³´ì„ ëŠë‚Œ */
        .btn-fairytale {
            background: #5d4037; color: var(--paper-light);
            border: 2px solid var(--magic-gold); padding: 12px;
            cursor: pointer; width: 100%; font-size: 1.2rem;
            border-radius: 4px; box-shadow: 0 4px 0 #3e2723;
            transition: 0.1s;
        }
        .btn-fairytale:active { transform: translateY(4px); box-shadow: none; }
        .btn-fairytale:hover { filter: brightness(1.2); }

        /* íŠ¹ì„± íƒœê·¸: ë‚˜ë­‡ì ëŠë‚Œ */
        .leaf-tag {
            display: inline-block; padding: 4px 12px; margin: 3px;
            background: #d4e157; border-radius: 15px 0 15px 0;
            border: 1px solid #7b8d42; font-size: 0.9rem; cursor: pointer;
        }
        .leaf-tag.active { background: #689f38; color: white; box-shadow: 0 0 10px #689f38; }

        /* ë¹„ë°€ ê¸°ë¡ êµ¬ì—­ */
        .secret-area {
            background: rgba(183, 28, 28, 0.05); border: 1px dashed #b71c1c;
            padding: 10px; border-radius: 5px; margin-top: 10px;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body onclick="createMagicSpark(event)">
    <div class="sepia-overlay"></div>
    <canvas id="fairy-canvas"></canvas>

    <div id="login-screen" class="screen active">
        <div class="book-panel" style="width: 350px; padding: 40px; text-align: center;">
            <h1 style="font-family: 'Nanum Myeongjo'; color: #3e2723;">ğŸ“– ê¸°ë¡ìì˜ ìˆ²</h1>
            <p>ëª¨í—˜ê°€ë‹˜ì˜ ì¸ì¥ì„ ì°ì–´ì£¼ì„¸ìš”</p>
            <input type="email" id="login-email" placeholder="ì´ë©”ì¼ ì£¼ì†Œ">
            <input type="password" id="login-pw" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <button class="btn-fairytale" style="margin-top: 20px;" onclick="handleAuth('login')">ê¸°ë¡ì†Œ ì…ì¥</button>
            <p style="font-size: 0.8rem; margin-top: 15px; cursor: pointer; color: #8b5a2b;" onclick="handleAuth('signup')">ìƒˆë¡œìš´ ëª¨í—˜ê°€ ë“±ë¡(íšŒì›ê°€ì…)</p>
        </div>
    </div>

    <div id="main-screen" class="screen">
        <div class="main-container">
            <div class="book-panel">
                <div style="padding: 15px; border-bottom: 2px solid #8b5a2b; background: rgba(0,0,0,0.03);">
                    <h2 style="margin:0; font-family: 'Nanum Myeongjo'; font-size: 1.2rem;">ğŸ“œ ë™ë£Œë“¤ì˜ ì¼ì§€</h2>
                </div>
                <div class="scroll-list" id="hero-list">
                    </div>
                <div style="padding: 10px;">
                    <button class="btn-fairytale" style="font-size: 1rem;" onclick="resetForm()">+ ìƒˆ í˜ì´ì§€ ì‘ì„±</button>
                </div>
            </div>

            <div class="hero-portal">
                <img id="main-display-img" class="hero-main-img" src="" style="display: none;">
                <div id="empty-msg" style="text-align: center;">
                    <div style="font-size: 5rem; opacity: 0.3;">âœ¨</div>
                    <p>ì´ˆìƒí™”ë¥¼ ë¶ˆëŸ¬ì˜¤ë ¤ë©´ ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”</p>
                    <button class="btn-fairytale" onclick="document.getElementById('file-input').click()">ì´ë¯¸ì§€ ì„ íƒ</button>
                    <input type="file" id="file-input" hidden onchange="previewHero(event)">
                </div>
            </div>

            <div class="book-panel" style="padding: 25px; overflow-y: auto;">
                <h2 id="form-title" style="margin-top: 0; font-family: 'Nanum Myeongjo'; border-bottom: 2px solid #8b5a2b;">CHARACTER LOG</h2>
                
                <div class="stat-group">
                    <label>ì´ë¦„</label>
                    <input type="text" id="nickname" placeholder="ë¬´ì—‡ì´ë¼ ë¶€ë¥¼ê¹Œìš”?">
                </div>

                <div style="display: flex; gap: 10px;">
                    <div class="stat-group" style="flex:1;">
                        <label>ì¢…ì¡±</label>
                        <select id="race">
                            <option>ì¸ê°„</option><option>ì—˜í”„</option><option>ìˆ˜ì¸</option><option>ë“œì›Œí”„</option><option>ì •ë ¹</option>
                        </select>
                    </div>
                    <div class="stat-group" style="flex:1;">
                        <label>ì„±ë³„</label>
                        <select id="gender"><option>ë‚¨ì„±</option><option>ì—¬ì„±</option><option>ê¸°íƒ€</option></select>
                    </div>
                </div>

                <div class="stat-group">
                    <label>íŠ¹ì„±</label>
                    <div id="traits">
                        <span class="leaf-tag" onclick="this.classList.toggle('active')">ë‹¤ì •í•¨</span>
                        <span class="leaf-tag" onclick="this.classList.toggle('active')">ìš©ë§¹í•¨</span>
                        <span class="leaf-tag" onclick="this.classList.toggle('active')">ì§€í˜œë¡œì›€</span>
                        <span class="leaf-tag" onclick="addCustomTrait()">+</span>
                    </div>
                </div>

                <div class="stat-group">
                    <label>ì´ì•¼ê¸° (Bio)</label>
                    <textarea id="bio" rows="4" placeholder="ì–´ë–¤ ëª¨í—˜ì„ ê±°ì³ì™”ë‚˜ìš”?"></textarea>
                </div>

                <div class="secret-area">
                    <label style="color: #b71c1c; font-size: 0.9rem;">ğŸ”’ ë¹„ë°€ ê¸°ë¡ (ì‘ì„±ì/ê´€ë¦¬ì ì „ìš©)</label>
                    <textarea id="note" style="border-bottom-color: #b71c1c;"></textarea>
                </div>

                <div id="btn-ctrl" style="margin-top: 20px;">
                    <button id="save-btn" class="btn-fairytale" onclick="saveToBook()">ê¸°ë¡ ì €ì¥í•˜ê¸°</button>
                    <div id="edit-ctrl" style="display: none; gap: 8px;">
                        <button class="btn-fairytale" style="flex:1;" onclick="updateBook()">ìˆ˜ì •</button>
                        <button class="btn-fairytale" style="flex:1; background: #b71c1c;" onclick="deleteFromBook()">ì‚­ì œ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB9zSYPDBJRt2oTIcbEa8kxZplCvSPazUU",
            authDomain: "prof-f0cd2.firebaseapp.com",
            projectId: "prof-f0cd2",
            storageBucket: "prof-f0cd2.firebasestorage.app",
            messagingSenderId: "966274708581",
            appId: "1:966274708581:web:1f77eae3bb147c0bce028c"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let userSession = null;
        let selectedFile = null;
        let currentDocId = null;

        // --- ê¸°ëŠ¥ ë³µêµ¬: ë¡œê·¸ì¸ ---
        window.handleAuth = async (type) => {
            const email = document.getElementById('login-email').value;
            const pw = document.getElementById('login-pw').value;
            if(!email || !pw) return alert("ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì ì–´ì£¼ì„¸ìš”!");
            try {
                if(type === 'login') await signInWithEmailAndPassword(auth, email, pw);
                else await createUserWithEmailAndPassword(auth, email, pw);
            } catch(e) { alert(e.message); }
        };

        onAuthStateChanged(auth, (user) => {
            if(user) {
                userSession = user;
                document.getElementById('login-screen').classList.remove('active');
                document.getElementById('main-screen').classList.add('active');
                loadArchives();
            } else {
                document.getElementById('login-screen').classList.add('active');
            }
        });

        // --- ê¸°ëŠ¥ ë³µêµ¬: ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ---
        window.previewHero = (e) => {
            selectedFile = e.target.files[0];
            const reader = new FileReader();
            reader.onload = () => {
                const img = document.getElementById('main-display-img');
                img.src = reader.result; img.style.display = 'block';
                document.getElementById('empty-msg').style.display = 'none';
            };
            reader.readAsDataURL(selectedFile);
        };

        // --- ê¸°ëŠ¥ ë³µêµ¬: ë°ì´í„° ì €ì¥ (Create) ---
        window.saveToBook = async () => {
            const name = document.getElementById('nickname').value;
            if(!name) return alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!");

            let url = "https://via.placeholder.com/400?text=No+Portrait";
            if(selectedFile) {
                const sRef = ref(storage, `heroes/${Date.now()}`);
                await uploadBytes(sRef, selectedFile);
                url = await getDownloadURL(sRef);
            }

            await addDoc(collection(db, "characters"), {
                nickname: name, race: document.getElementById('race').value,
                gender: document.getElementById('gender').value,
                bio: document.getElementById('bio').value,
                note: document.getElementById('note').value,
                traits: [...document.querySelectorAll('.leaf-tag.active')].map(t => t.innerText),
                imageUrl: url, author: userSession.uid, time: new Date()
            });
            alert("ê¸°ë¡ì„ ë‚¨ê²¼ìŠµë‹ˆë‹¤."); resetForm();
        };

        // --- ê¸°ëŠ¥ ë³µêµ¬: ì‹¤ì‹œê°„ ë¦¬ìŠ¤íŠ¸ (Read) ---
        function loadArchives() {
            onSnapshot(query(collection(db, "characters"), orderBy("time", "desc")), (snap) => {
                const list = document.getElementById('hero-list');
                list.innerHTML = "";
                snap.forEach(d => {
                    const data = d.data();
                    const div = document.createElement('div');
                    div.className = "archive-card";
                    div.innerHTML = `<img src="${data.imageUrl}" class="mini-pfp">
                                    <div><b>${data.nickname}</b><br><small>${data.race} / ${data.gender}</small></div>`;
                    div.onclick = () => showDetail(d.id, data);
                    list.appendChild(div);
                });
            });
        }

        // --- ê¸°ëŠ¥ ë³µêµ¬: ìƒì„¸ ë³´ê¸° & ê¶Œí•œ ë¶„ê¸° ---
        function showDetail(id, data) {
            currentDocId = id;
            document.getElementById('nickname').value = data.nickname;
            document.getElementById('race').value = data.race;
            document.getElementById('gender').value = data.gender;
            document.getElementById('bio').value = data.bio;
            document.getElementById('note').value = data.note;
            document.getElementById('main-display-img').src = data.imageUrl;
            document.getElementById('main-display-img').style.display = 'block';
            document.getElementById('empty-msg').style.display = 'none';
            
            document.querySelectorAll('.leaf-tag').forEach(t => {
                t.classList.toggle('active', data.traits.includes(t.innerText));
            });

            const isOwner = userSession.uid === data.author;
            document.getElementById('save-btn').style.display = 'none';
            document.getElementById('edit-ctrl').style.display = isOwner ? 'flex' : 'none';
            document.getElementById('form-title').innerText = isOwner ? "ë‚´ ê¸°ë¡ ìˆ˜ì •" : "ê¸°ë¡ ì—´ëŒ";
        }

        window.updateBook = async () => {
            await updateDoc(doc(db, "characters", currentDocId), {
                nickname: document.getElementById('nickname').value,
                race: document.getElementById('race').value,
                bio: document.getElementById('bio').value,
                note: document.getElementById('note').value,
                traits: [...document.querySelectorAll('.leaf-tag.active')].map(t => t.innerText)
            });
            alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
        };

        window.deleteFromBook = async () => {
            if(confirm("ì´ ê¸°ë¡ì„ ì˜ì›íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                await deleteDoc(doc(db, "characters", currentDocId));
                resetForm();
            }
        };

        window.resetForm = () => {
            currentDocId = null;
            document.getElementById('main-display-img').style.display = 'none';
            document.getElementById('empty-msg').style.display = 'block';
            document.getElementById('save-btn').style.display = 'block';
            document.getElementById('edit-ctrl').style.display = 'none';
            ['nickname', 'bio', 'note'].forEach(id => document.getElementById(id).value = "");
            document.querySelectorAll('.leaf-tag').forEach(t => t.classList.remove('active'));
        };

        // --- íš¨ê³¼: ë§ˆë²• ë°˜ì§ì´ (Canvas) ---
        const canvas = document.getElementById('fairy-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        let sparks = [];
        class Spark {
            constructor(x, y) {
                this.x = x; this.y = y;
                this.size = Math.random() * 5 + 1;
                this.vX = Math.random() * 2 - 1;
                this.vY = Math.random() * 2 - 1;
                this.life = 1;
            }
            update() { this.x += this.vX; this.y += this.vY; this.life -= 0.01; }
            draw() {
                ctx.globalAlpha = this.life;
                ctx.fillStyle = "#fffce0";
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill();
            }
        }
        window.createMagicSpark = (e) => {
            for(let i=0; i<8; i++) sparks.push(new Spark(e.clientX, e.clientY));
        };
        function anim() {
            ctx.clearRect(0,0,canvas.width, canvas.height);
            sparks = sparks.filter(s => s.life > 0);
            sparks.forEach(s => { s.update(); s.draw(); });
            requestAnimationFrame(anim);
        }
        anim();
    </script>
</body>
</html>