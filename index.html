<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë™í™” ì† ëª¨í—˜: ìºë¦­í„° ì•„ì¹´ì´ë¸Œ</title>
    <link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@400;700&family=Nanum+Brush+Script&family=Cinzel+Decorative:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --magic-gold: #fde08d;
            --deep-wood: #2c1b10;
            --scroll-paper: #f4e4bc;
            --accent-green: #4ade80;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            font-family: 'Gaegu', cursive;
            /* ë°°ê²½: ë™í™”ì ì´ê³  ë”°ëœ»í•œ ë§ˆì„ ì „ê²½ (AI ìƒì„± ì´ë¯¸ì§€ í’) */
            background: url('https://images.unsplash.com/photo-1518709268805-4e9042af9f23?q=80&w=1920&auto=format&fit=crop') no-repeat center center fixed;
            background-size: cover;
            overflow: hidden; color: var(--deep-wood);
        }

        /* ì „ì²´ ì˜¤ë²„ë ˆì´: ë¶€ë“œëŸ¬ìš´ ì•ˆê°œ íš¨ê³¼ */
        .overlay {
            position: fixed; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0) 30%, rgba(44,27,16,0.4) 100%);
            pointer-events: none; z-index: 1;
        }

        .screen { display: none; width: 100%; height: 100%; position: absolute; justify-content: center; align-items: center; z-index: 10; }
        .active { display: flex; }

        /* íŒíƒ€ì§€ ì–‘í”¼ì§€ íŒ¨ë„ */
        .parchment {
            background: var(--scroll-paper);
            background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            border: 8px double #8b5a2b;
            box-shadow: 0 0 0 4px var(--magic-gold), 0 20px 50px rgba(0,0,0,0.5);
            border-radius: 20px; padding: 30px; position: relative;
        }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ: ë™í™”í’ ë ˆì´ì•„ì›ƒ */
        .main-container {
            display: grid; grid-template-columns: 320px 1fr 420px;
            width: 95%; height: 90%; gap: 20px; z-index: 2;
        }

        /* ìºë¦­í„° ì´ˆìƒí™” í”„ë ˆì„ (ë™í™”í’ ìˆ²/ë‚˜ë¬´ ëŠë‚Œ) */
        .portrait-frame {
            width: 100%; height: 100%;
            border-radius: 15px; border: 12px solid #3d2b1f;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(5px);
            position: relative; overflow: hidden;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }

        /* ì…ë ¥ í•„ë“œ: ì‰í¬ë³‘ê³¼ ê¹ƒíœ ëŠë‚Œ */
        input, textarea, select {
            background: rgba(0,0,0,0.05); border: none;
            border-bottom: 2px solid #8b5a2b; color: #1a1a1a;
            padding: 10px; margin: 10px 0; width: 100%;
            font-family: 'Gaegu', cursive; font-size: 1.1rem;
        }
        input:focus { outline: none; border-bottom-color: var(--accent-green); background: rgba(255,255,255,0.2); }

        /* ë²„íŠ¼: ì ¬(Gem) ë°•íŒ ë§¤ì§ ë²„íŠ¼ */
        .btn-magic {
            background: linear-gradient(to bottom, #8b5a2b, #4e342e);
            border: 2px solid var(--magic-gold); border-radius: 50px;
            color: var(--magic-gold); padding: 12px 25px;
            font-size: 1.2rem; cursor: pointer; font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            transition: 0.3s; margin-top: 10px;
        }
        .btn-magic:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 15px var(--magic-gold);
            filter: brightness(1.2);
        }

        /* íŠ¹ì„± íƒœê·¸: ë‚˜ë­‡ì ëŠë‚Œ */
        .trait-tag {
            display: inline-block; padding: 5px 15px; margin: 5px;
            background: #e2d1a6; border-radius: 20px;
            border: 1px dashed #8b5a2b; cursor: pointer; transition: 0.2s;
        }
        .trait-tag.active {
            background: var(--accent-green); color: white; border-style: solid;
            box-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
        }

        /* ë¡œê·¸ì¸ í¼ íŠ¹ìˆ˜ ìŠ¤íƒ€ì¼ */
        .login-box {
            text-align: center; max-width: 400px;
        }
        .login-box h1 { font-family: 'Cinzel Decorative', cursive; color: #5d4037; }

        /* ì•„ì¹´ì´ë¸Œ ë¦¬ìŠ¤íŠ¸ */
        .scroll-list { overflow-y: auto; height: 100%; }
        .archive-item {
            display: flex; align-items: center; gap: 15px;
            padding: 15px; margin-bottom: 10px;
            background: rgba(255,255,255,0.3); border-radius: 10px;
            cursor: pointer; border: 1px solid transparent;
        }
        .archive-item:hover { border-color: var(--magic-gold); background: rgba(255,255,255,0.5); }
        .mini-pfp { width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--magic-gold); object-fit: cover; }

    </style>
</head>
<body>
    <div class="overlay"></div>

    <div id="login-screen" class="screen active">
        <div class="parchment login-box">
            <h1>âœ¨ ARCHIVE GATE âœ¨</h1>
            <p>ëª¨í—˜ê°€ë‹˜, ê¸°ë¡ì˜ ì„œì— ë¡œê·¸ì¸í•˜ì„¸ìš”</p>
            <input type="email" id="login-email" placeholder="ì´ë©”ì¼ ì£¼ì†Œ">
            <input type="password" id="login-pw" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <button class="btn-magic" onclick="handleEmailAuth('login')">ì ‘ì†í•˜ê¸°</button>
            <p style="font-size: 0.9rem; color: #8b5a2b; cursor: pointer; margin-top:15px;" onclick="handleEmailAuth('signup')">ìƒˆë¡œìš´ ëª¨í—˜ê°€ ë“±ë¡(íšŒì›ê°€ì…)</p>
        </div>
    </div>

    <div id="main-screen" class="screen">
        <div class="main-container">
            
            <div class="parchment" style="padding: 20px;">
                <h2 style="font-family: 'Cinzel Decorative'; text-align: center;">ğŸ“œ ARCHIVES</h2>
                <div class="scroll-list" id="char-list">
                    </div>
                <button class="btn-magic" style="width:100%; margin-top: 10px;" onclick="resetForm()">+ ìƒˆ ê¸°ë¡ ì‘ì„±</button>
            </div>

            <div class="portrait-frame">
                <img id="view-img" style="width:100%; height:100%; object-fit:cover; display:none;">
                <div id="upload-zone" style="text-align: center;">
                    <div style="font-size: 4rem;">ğŸ–¼ï¸</div>
                    <button class="btn-magic" onclick="document.getElementById('file-input').click()">ì´ˆìƒí™” ë¶ˆëŸ¬ì˜¤ê¸°</button>
                    <input type="file" id="file-input" hidden onchange="previewImage(event)">
                </div>
            </div>

            <div class="parchment" style="overflow-y: auto;">
                <h2 id="mode-title" style="font-family: 'Cinzel Decorative'; margin-top:0;">CHARACTER LOG</h2>
                
                <label>ì´ë¦„</label>
                <input type="text" id="nickname" placeholder="ëª¨í—˜ê°€ì˜ ì´ë¦„">

                <div style="display: flex; gap: 15px;">
                    <div style="flex:1;">
                        <label>ì¢…ì¡±</label>
                        <select id="race">
                            <option>ì¸ê°„</option><option>ì—˜í”„</option><option>ìˆ˜ì¸</option><option>ì •ë ¹</option>
                        </select>
                    </div>
                    <div style="flex:1;">
                        <label>ì„±ë³„</label>
                        <select id="gender">
                            <option>ë‚¨ì„±</option><option>ì—¬ì„±</option><option>ì¤‘ì„±</option>
                        </select>
                    </div>
                </div>

                <label>íŠ¹ì„±</label>
                <div id="trait-box">
                    <span class="trait-tag" onclick="this.classList.toggle('active')">ë‹¤ì •í•¨</span>
                    <span class="trait-tag" onclick="this.classList.toggle('active')">ìš©ë§¹í•¨</span>
                    <span class="trait-tag" onclick="this.classList.toggle('active')">ì‹ ë¹„ë¡œì›€</span>
                    <span class="trait-tag" onclick="addCustomTrait()">+ ì¶”ê°€</span>
                </div>

                <label>ì´ì•¼ê¸° (Bio)</label>
                <textarea id="bio" rows="4" placeholder="ì–´ë–¤ ëª¨í—˜ì„ ê±°ì³ì™”ë‚˜ìš”?"></textarea>

                <div style="background: rgba(139, 90, 43, 0.1); padding: 10px; border-radius: 10px; margin-top: 10px;">
                    <label style="color: #b71c1c;">ğŸ”’ ë¹„ë°€ ê¸°ë¡ (ê´€ë¦¬ì ì „ìš©)</label>
                    <textarea id="secret-note" style="border-bottom-color: #b71c1c;"></textarea>
                </div>

                <div id="btn-group" style="margin-top: 20px;">
                    <button id="save-btn" class="btn-magic" style="width:100%;" onclick="saveData()">ê¸°ë¡ ì €ì¥í•˜ê¸°</button>
                    <div id="edit-group" style="display:none; gap:10px;">
                        <button class="btn-magic" style="flex:1;" onclick="updateData()">ìˆ˜ì •</button>
                        <button class="btn-magic" style="flex:1; background: #b71c1c;" onclick="deleteData()">ì‚­ì œ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase ì„¤ì • (ì´ì „ê³¼ ë™ì¼í•˜ë˜ ë””ìì¸ì— ë§ê²Œ ìµœì í™”ëœ ë¡œì§ ì ìš©)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB9zSYPDBJRt2oTIcbEa8kxZplCvSPazUU",
            authDomain: "prof-f0cd2.firebaseapp.com",
            projectId: "prof-f0cd2",
            storageBucket: "prof-f0cd2.firebasestorage.app",
            messagingSenderId: "966274708581",
            appId: "1:966274708581:web:1f77eae3bb147c0bce028c"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let userSession = null;
        let selectedFile = null;
        let currentId = null;

        // ì´ë©”ì¼ ë¡œê·¸ì¸ ì²˜ë¦¬
        window.handleEmailAuth = async (type) => {
            const email = document.getElementById('login-email').value;
            const pw = document.getElementById('login-pw').value;
            if(!email || !pw) return alert("ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");

            try {
                if(type === 'login') await signInWithEmailAndPassword(auth, email, pw);
                else {
                    await createUserWithEmailAndPassword(auth, email, pw);
                    alert("í™˜ì˜í•©ë‹ˆë‹¤, ëª¨í—˜ê°€ë‹˜! ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                }
            } catch(e) { alert("ì˜¤ë¥˜: " + e.message); }
        };

        onAuthStateChanged(auth, (user) => {
            if(user) {
                userSession = user;
                document.getElementById('login-screen').classList.remove('active');
                document.getElementById('main-screen').classList.add('active');
                loadArchives();
            } else {
                document.getElementById('login-screen').classList.add('active');
                document.getElementById('main-screen').classList.remove('active');
            }
        });

        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
        window.previewImage = (e) => {
            selectedFile = e.target.files[0];
            const reader = new FileReader();
            reader.onload = () => {
                const img = document.getElementById('view-img');
                img.src = reader.result; img.style.display = 'block';
                document.getElementById('upload-zone').style.display = 'none';
            };
            reader.readAsDataURL(selectedFile);
        };

        // ë°ì´í„° ì €ì¥
        window.saveData = async () => {
            const name = document.getElementById('nickname').value;
            if(!name) return alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!");

            let url = "https://via.placeholder.com/400?text=No+Image";
            if(selectedFile) {
                const sRef = ref(storage, `books/${Date.now()}`);
                await uploadBytes(sRef, selectedFile);
                url = await getDownloadURL(sRef);
            }

            await addDoc(collection(db, "characters"), {
                nickname: name, race: document.getElementById('race').value,
                gender: document.getElementById('gender').value,
                bio: document.getElementById('bio').value,
                secret: document.getElementById('secret-note').value,
                imageUrl: url, author: userSession.uid,
                traits: [...document.querySelectorAll('.trait-tag.active')].map(t => t.innerText),
                time: new Date()
            });
            alert("ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!"); resetForm();
        };

        // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (ì‹¤ì‹œê°„)
        function loadArchives() {
            onSnapshot(query(collection(db, "characters"), orderBy("time", "desc")), (snap) => {
                const list = document.getElementById('char-list');
                list.innerHTML = "";
                snap.forEach(d => {
                    const item = d.data();
                    const div = document.createElement('div');
                    div.className = "archive-item";
                    div.innerHTML = `<img src="${item.imageUrl}" class="mini-pfp">
                                    <div><b>${item.nickname}</b><br><small>${item.race} / ${item.gender}</small></div>`;
                    div.onclick = () => showDetail(d.id, item);
                    list.appendChild(div);
                });
            });
        }

        function showDetail(id, data) {
            currentId = id;
            document.getElementById('nickname').value = data.nickname;
            document.getElementById('race').value = data.race;
            document.getElementById('gender').value = data.gender;
            document.getElementById('bio').value = data.bio;
            document.getElementById('secret-note').value = data.secret;
            document.getElementById('view-img').src = data.imageUrl;
            document.getElementById('view-img').style.display = 'block';
            document.getElementById('upload-zone').style.display = 'none';
            
            // íƒœê·¸ í™œì„±í™”
            document.querySelectorAll('.trait-tag').forEach(t => {
                t.classList.toggle('active', data.traits.includes(t.innerText));
            });

            // ê¶Œí•œ ì œì–´ (ë³¸ì¸ ê¸€ì¼ ë•Œë§Œ ìˆ˜ì •/ì‚­ì œ ë³´ì„)
            const isOwner = userSession.uid === data.author;
            document.getElementById('save-btn').style.display = 'none';
            document.getElementById('edit-group').style.display = isOwner ? 'flex' : 'none';
            document.getElementById('mode-title').innerText = isOwner ? "MY RECORD" : "ARCHIVE VIEW";
        }

        window.resetForm = () => {
            currentId = null;
            document.getElementById('nickname').value = "";
            document.getElementById('bio').value = "";
            document.getElementById('view-img').style.display = 'none';
            document.getElementById('upload-zone').style.display = 'block';
            document.getElementById('save-btn').style.display = 'block';
            document.getElementById('edit-group').style.display = 'none';
            document.querySelectorAll('.trait-tag').forEach(t => t.classList.remove('active'));
        };

        window.addCustomTrait = () => {
            const val = prompt("ìƒˆë¡œìš´ íŠ¹ì„±:");
            if(val) {
                const span = document.createElement('span');
                span.className = 'trait-tag active'; span.innerText = val;
                span.onclick = function() { this.classList.toggle('active'); };
                document.getElementById('trait-box').insertBefore(span, document.querySelector('#trait-box span:last-child'));
            }
        }
    </script>
</body>
</html>